import{G as D,_ as j,t as Q,o as T,c as I,w as A,v,e as g,n as R,r as C,m as $,a as tt,D as nt,J as et,b as ot,F as rt,j as at,x as q,l as U,f as W,h as J}from"./index-5cTkXVTa.js";const H="974d3f8fd3cba3f83d098b4220669a93",X="./imgs/gis/null.png";function Y(l){const t=L.map(l,{preferCanvas:!0,positionControl:!1,attributionControl:!1,zoomControl:!1,zoomSnap:window.devicePixelRatio>1?.5:.1,scrollWheelZoom:!0,dragging:!0,keyboard:!1,touchZoom:!0,doubleClickZoom:!0,boxZoom:!0,tap:!0,maxBoundsViscosity:1,zoom:10,center:[25.87524527709376,114.89366983570925]});return L.tileLayer(`https://t{s}.tianditu.gov.cn/DataServer?T=img_w&x={x}&y={y}&l={z}&tk=${H}`,{subdomains:["0","1","2","3","4","5","6","7"],minZoom:4,maxZoom:21,maxNativeZoom:window.devicePixelRatio>1?17:18,detectRetina:!0,errorTileUrl:X}).addTo(t),L.tileLayer(`https://t{s}.tianditu.gov.cn/DataServer?T=cia_w&x={x}&y={y}&l={z}&tk=${H}`,{subdomains:["0","1","2","3","4","5","6","7"],minZoom:5,maxZoom:21,maxNativeZoom:window.devicePixelRatio>1?17:18,detectRetina:!0,errorTileUrl:X}).addTo(t),t}const Z={afterSearchPlaceMapZoom:17,minInsertDistance:10,iconOption:{iconUrl:"./imgs/circle.png",iconSize:[18,18],iconAnchor:[9,9]},groundStyle:{normal:{bubblingMouseEvents:!0,color:"#00f91a",weight:2,dashArray:"5,4,4",dashOffset:"1",fill:!0,fillColor:"#00f91a",fillOpacity:.15},focused:{bubblingMouseEvents:!0,color:"#ff9933",weight:3,dashArray:"5,4,4",dashOffset:"1",fill:!0,fillColor:"#ff9933",fillOpacity:.001}}};function st(l,t,e,n=10){const o=l.latLngToContainerPoint(t),r=l.latLngToContainerPoint(e),a=Math.abs(o.x-r.x),s=Math.abs(o.y-r.y);return Math.sqrt(a*a+s*s)<n}function N(l){return l.map(t=>[t[1],t[0]])}function B(l,t=!0){const e=N(l),n=turf.area(turf.polygon([e]));return(t?(n/666.66666).toFixed(2):n)-0}function it(l,t,e){let n=0;return n=l[1]*t[0]+t[1]*e[0]+e[1]*l[0]-t[1]*l[0]-e[1]*t[0]-l[1]*e[0],n/2}function K(l){if(l.length<3)return null;let t=0,e=0,n=0,o=l[1],r=null,a=0;for(let c=2;c<l.length;c++)r=l[c],a=it(l[0],o,r),n+=a,t+=(l[0][1]+o[1]+r[1])*a,e+=(l[0][0]+o[0]+r[0])*a,o=r;const s=e/n/3,i=t/n/3;return[s,i]}function lt(l,t,e){const[n,o]=l,[r,a]=t,[s,i]=e;let c=0,h=0,d=0,f=0,p=0;const m=Math.sqrt((r-n)*(r-n)+(a-o)*(a-o));if(m===0)return[0,{x:r,y:a}];const y=Math.sqrt((s-n)*(s-n)+(i-o)*(i-o));if(y===0)return[0,{x:s,y:i}];const w=Math.sqrt((r-s)*(r-s)+(a-i)*(a-i));if(w===0)return p=m,[p,{x:r,y:a}];if(m<y){if(a===i?r<s?c=0:c=Math.PI:(f=(s-r)/w,f-1>1e-5&&(f=1),c=Math.acos(f),a>i&&(c=Math.PI*2-c)),f=(n-r)/m,f-1>1e-5&&(f=1),h=Math.acos(f),a>o&&(h=Math.PI*2-h),d=h-c,d<0&&(d=-d),d>Math.PI&&(d=Math.PI*2-d),d>Math.PI/2)return[m,{x:r,y:a}];if(r===s)return[y*Math.sin(d),{x:r,y:o}];if(a===i)return[y*Math.sin(d),{x:n,y:a}];let P=0,G=0;const M=(i-a)/s-r,F=-1/M,u=o-n*F;return P=(i-s*M-u)/(F-M),G=F*P+u,[m*Math.sin(d),{x:P,y:G}]}if(a===i?r<s?c=Math.PI:c=0:(f=(r-s)/w,f-1>1e-5&&(f=1),c=Math.acos(f),i>a&&(c=Math.PI*2-c)),f=(n-s)/y,f-1>1e-5&&(f=1),h=Math.acos(f),i>o&&(h=Math.PI*2-h),d=h-c,d<0&&(d=-d),d>Math.PI&&(d=Math.PI*2-d),d>Math.PI/2)return[y,{x:s,y:i}];if(r===s)return[y*Math.sin(d),{x:r,y:o}];if(a===i)return[y*Math.sin(d),{x:n,y:a}];let b=0,_=0;const S=(i-a)/s-r,x=-1/S,E=o-n*x;return b=(i-s*S-E)/(x-S),_=x*b+E,[y*Math.sin(d),{x:b,y:_}]}function ct(l,t){const e=(l[0].x-t[0].x)*(l[1].y-t[0].y)-(l[0].y-t[0].y)*(l[1].x-t[0].x),n=(l[0].x-t[1].x)*(l[1].y-t[1].y)-(l[0].y-t[1].y)*(l[1].x-t[1].x);if(e*n>=0)return!1;const o=(t[0].x-l[0].x)*(t[1].y-l[0].y)-(t[0].y-l[0].y)*(t[1].x-l[0].x),r=o+e-n;return!(o*r>=0)}function dt(l,t){if(t.length<=3)return!1;let e=null,n=null,o=null,r=null;for(let a=3;a<t.length;a++){e=t[a],n=t[a-1];for(let s=1;s<=a-2;s++)if(o=t[s],r=t[s-1],ct([l.latLngToContainerPoint(e),l.latLngToContainerPoint(n)],[l.latLngToContainerPoint(o),l.latLngToContainerPoint(r)]))return!0}return!1}let O=null;class ut{constructor(t,e,n=!0,o=null){this.map=t,this.polylineArr=[],this.pointsArr=[],this.markersArr=[],this.addStack=[],this.drawGroup=null,this.area=0,this.isStarted=!1,this.isClosed=!1,this.canUndo=!1,this.canClear=!1,this.isFinished=!1,this.syncStatusFun=e,this.isMulti=n,this.addPointCheckFunc=o,this.ext=null,this.dragEndTimestamp=0,t.on("click",r=>{this.isStarted&&!this.isFinished&&this.doMapClick(r.latlng)})}init(t=null,e=!0,n=null){const o=this;o.drawGroup?o.drawGroup.clearLayers():o.drawGroup=L.layerGroup().addTo(o.map),o.map._drawGroup=o.drawGroup,t?(o.pointsArr=t.map(r=>({id:r.boundId,points:r.boundary.map(a=>({id:D(),latlng:a}))})),o.polylineArr=[],o.pointsArr.forEach((r,a)=>{r.points.forEach(s=>{o.addMarker(s.id,s.latlng,a)})}),o.computeArea(),o.isStarted=!0,o.isClosed=!0):(o.polylineArr=[],o.pointsArr=[],o.markersArr=[],o.addStack=[],o.area=0,o.isStarted=e,o.isClosed=!1),n&&(o.ext=n),o.syncStatus()}doMapClick({lat:t,lng:e}){const n=this,o=n.pointsArr,r=[t,e];if(Date.now()-n.dragEndTimestamp<800)return!1;if(n.isClosed)if(!n.insertPoint(r)&&n.isMulti)o.push({id:D(),points:[]}),n.isClosed=!1,n.syncStatus();else return!1;if(n.isMulti||n.addPointCheckFunc&&n.addPointCheckFunc(r,o)){const a=n.map,s=o.length;if(s&&o[s-1].points.length>2){const i=o[s-1].points;if(st(a,r,i[0].latlng)){n.isClosed=!0;const[c,h]=i[0].latlng;n.drawCircleMarker([c,h]),n.computeArea(),n.syncStatus()}else n.drawCircleMarker(r)}else n.drawCircleMarker(r)}}insertPoint(t){const e=this,n=e.pointsArr;if(n.length==0)return!1;const o=e.map;let r=null,a=null;const s=o.latLngToLayerPoint(t);let i=0,c=1e3,h=null,d=-1,f=-1,p=null;for(let m=0;m<n.length;m++){p=n[m].points;for(let y=0;y<p.length-1;y++)r=o.latLngToLayerPoint(L.latLng(p[y].latlng)),a=o.latLngToLayerPoint(L.latLng(p[y+1].latlng)),h=lt([s.x,s.y],[r.x,r.y],[a.x,a.y]),i=h[0],i<c&&(c=i,d=y,f=m)}if(c<Z.minInsertDistance){const m=D();p=n[f].points;for(let y=p.length-1;y>d;y--)p[y+1]=p[y];return p[d+1]={id:m,latlng:t},e.addMarker(m,t,f),e.computeArea(),e.syncStatus(),!0}else return e.syncStatus(),!1}addMarker(t,e,n){const o=this;o.addStack.push({id:t,index:n}),O||(O=L.icon(Z.iconOption));const r=L.marker(e,{icon:O,draggable:!0}).addTo(o.drawGroup);r.uid=t,r.uindex=n,r.on("drag",s=>{o.doDragCircleMarker(s)});const a=o.markersArr;a[n]||(a[n]=[]),a[n].push(r),o.refreshPolyline(n),o.syncStatus()}drawCircleMarker(t){const e=this,n=e.pointsArr;n.length==0&&n.push({id:D(),points:[]});const o=n.length-1,r=n[o].points,a=D();r.push({id:a,latlng:t}),e.addMarker(a,t,o)}refreshPolyline(t){const e=this;if(!e.polylineArr[t])e.polylineArr[t]=L.polyline(e.pointsArr[t].points.map(n=>n.latlng),Z.groundStyle.focused).addTo(e.drawGroup);else{const n=e.pointsArr[t];n?e.polylineArr[t].setLatLngs(n.points.map(o=>o.latlng)):(e.polylineArr[t].removeFrom(e.drawGroup),e.polylineArr.splice(t,1))}e.refreshPolylineLabels()}doDragCircleMarker(t){const e=this;if(e.isFinished)return;const n=t.target,o=n.uid,r=n.uindex,a=e.pointsArr[r].points,s=a.findIndex(i=>i.id==o);if(s>=0){const i=a[s],{lat:c,lng:h}=t.latlng;i.latlng=[c,h];const d=a.length;if((r<e.pointsArr.length-1||e.isClosed)&&(s==0||s==d-1)){const f=e.markersArr[r];let p=null;s==0?(a[d-1].latlng=[c,h],p=f.find(m=>m.uid==a[d-1].id)):s==d-1&&(a[0].latlng=[c,h],p=f.find(m=>m.uid==a[0].id)),p&&p.setLatLng(t.latlng)}e.dragEndTimestamp=Date.now(),e.computeArea(),e.refreshPolyline(r),e.syncStatus()}}doUndo(){const t=this,e=t.addStack;if(e.length){const{id:n,index:o}=e.pop(),r=t.pointsArr[o].points,a=r.findIndex(c=>c.id==n);a>=0&&(r.splice(a,1),r.length?t.isClosed=!1:(t.pointsArr.splice(o,1),t.isClosed=!!t.pointsArr.length),t.syncStatus());const s=t.markersArr[o],i=s.findIndex(c=>c.uid==n);if(i>=0){const c=s[i];s.splice(i,1),c.removeFrom(t.drawGroup),s.length||t.markersArr.splice(o,1)}t.refreshPolyline(o)}}doCheck(){const t=this,e=t.pointsArr;if(e.length==0)return;if(!t.isClosed)return{status:!1,msg:"请您绘制完成！"};let n=null,o=null,r=null,a=null;for(let s=0;s<e.length;s++){if(n=e[s].points.map(i=>i.latlng),dt(t.map,n))return{status:!1,msg:"绘制的区域不能有交叉，请您修改！"};r=turf.polygon([N(n)]);for(let i=s+1;i<e.length;i++)if(o=e[i].points.map(c=>c.latlng),a=turf.polygon([N(o)]),turf.booleanWithin(r,a)||turf.booleanWithin(a,r)||turf.booleanOverlap(r,a))return{status:!1,msg:"绘制区域重叠，请您修改！"}}return{status:!0}}computeArea(){const t=this,e=t.pointsArr;let n=0,o=e.length;t.isClosed||(o=o-1);let r=null;for(let a=0;a<o;a++)r=e[a].points.map(s=>s.latlng),n+=B(r);t.area=n?n.toFixed(2):""}getDrawDatas(){const t=this,e=[],n=t.pointsArr;let o=null,r=0,a=null,s=0,i=null;return n.forEach(c=>{o=c.points.map(h=>h.latlng),r=B(o),s+=r,i=K(o),e.push({boundary:o,center:i,area:r,boundId:isNaN(c.id)?"":c.id}),a||(a=i)}),s=s.toFixed(2)-0,t.ext?{center:a,datas:e,totalArea:s,...t.ext}:{center:a,datas:e,totalArea:s}}syncStatus(){const t=this;t.syncStatusFun&&t.syncStatusFun({area:t.area,isStarted:t.isStarted,isClosed:t.isClosed,canUndo:t.addStack.length>0,canClear:!!(t.isStarted&&t.pointsArr.length),pointsArr:t.pointsArr})}delBound(t){const e=this,n=e.drawGroup,o=t==e.pointsArr.length-1;e.addStack=e.addStack.filter(r=>r.index!=t),e.addStack.forEach(r=>{r.index>t&&(r.index=r.index-1)}),e.markersArr[t].forEach(r=>r.removeFrom(n)),e.markersArr.splice(t,1),e.markersArr.forEach((r,a)=>{r.forEach(s=>{s.nIndex=a})}),e.polylineArr[t].unbindTooltip(),e.polylineArr[t].removeFrom(n),e.polylineArr.splice(t,1),e.pointsArr.splice(t,1),o&&!e.isClosed&&(e.isClosed=!0),e.computeArea(),e.refreshPolylineLabels(),e.syncStatus()}refreshPolylineLabels(){const t=this,e=t.pointsArr;let n=null,o=null;t.drawGroup.eachLayer(r=>{r.boundlabel&&r.removeFrom(t.drawGroup)}),t.polylineArr.length>1&&t.polylineArr.forEach((r,a)=>{o=e[a].points.map(s=>s.latlng),o.length>3&&(n=L.circleMarker(K(o),{radius:0,opacity:0,interactive:!1}).addTo(t.drawGroup),n.boundlabel=!0,n.bindTooltip("范围"+(a+1),{direction:"center",permanent:!0,className:"bound-label"}))})}setFinishedStatus(t){this.isFinished=t,this.markersArr.forEach(e=>{e.forEach(n=>{n.dragging&&(t?n.dragging.disable():n.dragging.enable())})})}}const ft={props:{canUndo:{type:Boolean,default:!1},canClear:{type:Boolean,default:!1}},setup(l,{emit:t}){const{canUndo:e,canClear:n}=Q(l);return{doPopOpeEvent:r=>{(r=="undo"&&e.value||r=="clear"&&n.value)&&t("ope",r)}}}},pt={class:"draw-tools"};function ht(l,t,e,n,o,r){return T(),I("ul",pt,[A(g("li",{"data-title":"撤销上一步",onClick:t[0]||(t[0]=a=>n.doPopOpeEvent("undo")),class:R([{disabled:!e.canUndo},"_tooltip"])},t[2]||(t[2]=[g("i",{class:"iconfont"},"",-1)]),2),[[v,e.canUndo]]),A(g("li",{"data-title":"清空",onClick:t[1]||(t[1]=a=>n.doPopOpeEvent("clear")),class:R([{disabled:!e.canClear},"_tooltip"])},t[3]||(t[3]=[g("i",{class:"iconfont"},"",-1)]),2),[[v,e.canClear]])])}const mt=j(ft,[["render",ht]]),yt={setup(){return{datas:C([])}}},gt={class:"layers-list"};function Ct(l,t,e,n,o,r){return T(),I("div",gt,t[0]||(t[0]=[g("h5",null,"图层管理",-1),g("ul",null,[g("li")],-1)]))}const kt=j(yt,[["render",Ct]]),At={components:{Tools:mt,Layers:kt},setup(){const l=C(null);let t=null;const e=$();let n=null;const o=C(""),r=C(""),a=C(""),s=C(!1),i=C(!1),c=C(!1),h=C(!1),d=C([]),f=C(!1),p=C(!1);let m=null;const y=u=>{s.value=u.isStarted,i.value=u.isClosed,a.value=u.area,c.value=u.canUndo,h.value=u.canClear,d.value=u.pointsArr},w=u=>{if(u=="undo")n.doUndo();else if(u=="clear"){n.init();const k=n.getDrawDatas();console.log("clear drawDatas...",k),emit("commit",k)}},b=()=>{n.init(null,!1)},_=()=>{n.init(null,!1),s.value=!1,p.value=!1,n.setFinishedStatus(!1)},S=(u,k)=>{if(u){if(t.hasLayer(m)&&m.removeFrom(t),n.init(u),u.length==0){const z=k.lat?[k.lat-0,k.lng-0]:null;z&&(console.log("add red flag....",z),L.marker(z,{icon:markerIcon,riseOnHover:!0}).addTo(t._drawGroup))}}else n.init()},x=()=>{const u=n.doCheck();if(console.log("checkRes....",u),!u||!u.status){u&&e.error(u.msg);return}const k=n.getDrawDatas();console.log("drawDatas...",k),emit("commit",k),p.value=!0,n.setFinishedStatus(!0)},E=u=>{t.setView(u,Z.afterSearchPlaceMapZoom)},V=()=>{t&&(t.invalidateSize(!1),setTimeout(()=>{t.invalidateSize(!1)},100))},P=()=>{p.value=!1,n.setFinishedStatus(!1)},G=u=>{p.value=u,n.setFinishedStatus(u)},M=u=>{n.delBound(u)},F=()=>d.value.length==0||s.value&&i.value&&p.value;return tt(async()=>{await nt(),t=Y(l.value),window.turf||et("https://cdn.bootcdn.net/ajax/libs/Turf.js/6.5.0/turf.min.js","turf-js"),m=L.layerGroup(),t.on("zoom",()=>{o.value=parseInt(t.getZoom())}),t.on("mousemove",u=>{r.value=u.latlng.lat+","+u.latlng.lng}),o.value=parseInt(t.getZoom()),m.addTo(t),n=new ut(t,y,!0,null),f.value=!0,p.value=!1}),ot(()=>{mapInstance.remove()}),{mapContainerEl:l,currZoom:o,currLatlng:r,currArea:a,isStarted:s,isClosed:i,canUndo:c,canClear:h,pointsArr:d,isInited:f,isFinished:p,isFinishDrawing:F,doResize:V,init:Y,doFocusPlace:E,doStartDraw:S,doFinishDraw:x,doClickTool:w,doClearDraw:_,doCancelDraw:b,doContinueDraw:P,doSetFinishStatus:G,doDelBound:M}}},vt={class:"tools-map-draw-print-page _page"},wt={class:"map-container"},bt={class:"bounds-list"},St=["onClick"],xt={class:"curr-zoom"};function Pt(l,t,e,n,o,r){const a=J("Tools"),s=J("Layers");return T(),I("div",vt,[g("div",wt,[g("div",{ref:"mapContainerEl",class:R({drawing:n.isStarted&&!n.isFinished})},null,2)]),A(g("ul",bt,[(T(!0),I(rt,null,at(n.pointsArr,(i,c)=>(T(),I("li",{key:c},[q("范围"+U(c+1),1),g("a",{onClick:h=>n.doDelBound(c),class:"iconfont"},"",8,St)]))),128))],512),[[v,n.pointsArr.length>1&&n.isStarted&&!n.isFinished]]),g("div",xt,[q(U(n.currZoom),1),A(g("span",null,U(n.currArea)+"亩",513),[[v,n.currArea]]),g("span",null,U(n.currLatlng),1)]),A(W(a,{onOpe:n.doClickTool,canUndo:n.canUndo,canClear:n.canClear},null,8,["onOpe","canUndo","canClear"]),[[v,!n.isFinished]]),A(g("button",{class:"start-button",onClick:t[0]||(t[0]=i=>n.doStartDraw())},"开始圈画",512),[[v,!n.isStarted]]),A(g("button",{class:"finish-button",onClick:t[1]||(t[1]=i=>n.doFinishDraw())},"完成圈画",512),[[v,n.isStarted&&n.isClosed&&!n.isFinished]]),A(g("button",{class:"finish-button",onClick:t[2]||(t[2]=i=>n.doContinueDraw())},"调整圈画",512),[[v,n.isStarted&&n.isClosed&&n.isFinished]]),W(s)])}const Mt=j(At,[["render",Pt]]);export{Mt as default};
