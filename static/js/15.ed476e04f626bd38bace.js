webpackJsonp([15],{ZovL:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a={extends:n("3ErM").a},i={render:function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"page article"},[n("h2",{staticClass:"title"},[e._v("ApiCloud平台的使用")]),e._v(" "),e._m(0),e._v(" "),n("footer",[e._v("2018年03月16日")]),e._v(" "),n("Comments"),e._v(" "),n("Catalog",{attrs:{catalog:e.catalog}}),e._v(" "),n("Preview",{attrs:{"is-show":e.showPreview,list:e.previewList,index:e.previewIndex},on:{"update:isShow":function(t){e.showPreview=t}}})],1)},staticRenderFns:[function(){var e=this,t=e.$createElement,n=e._self._c||t;return n("div",{staticClass:"content"},[n("p",[e._v("为着构建一个blog，一直到寻找可以提供免费数据存储的方案。GitHub Pages提供了免费的代码托管与静态页面服务，如果有个平台可以提供云数据库及相应请求数据的Api，就可以实现功能更为丰富的Web应用了。ApiCloud平台（"),n("a",{attrs:{href:"https://www.apicloud.com"}},[e._v("https://www.apicloud.com/")]),e._v("）正好提供了这种服务。")]),e._v(" "),n("p",[e._v("其实这个平台主要用于App的开发，而我主要是使用了它的云Database来存储数据（包括一些图片），这个只是ApiCloud平台的一小部分功能。")]),e._v(" "),n("p",[e._v("下面是一些经验总结。")]),e._v(" "),n("h3",{staticClass:"title"},[e._v("开启云服务")]),e._v(" "),n("p",[e._v("ApiCloud平台提供云存储，我们可以利用它免费存储一些文件。")]),e._v(" "),n("p",[e._v("新建一个应用之后，选择左侧“云开发”下面的“云设置”，选择“七牛云存储”，另一个“又拍云存储”之前试过有问题，上传文件之后无法访问，不知道现在修复没有！")]),e._v(" "),n("figure",{staticClass:"common"},[n("img",{staticStyle:{"max-width":"900px"},attrs:{src:"http://800cx2.com1.z0.glb.clouddn.com/apicloud/c0804ae9a1321d903995b11ac208b9a7.png"}})]),e._v(" "),n("figure",{staticClass:"common"},[n("img",{staticStyle:{"max-width":"600px"},attrs:{src:"http://800cx2.com1.z0.glb.clouddn.com/apicloud/8f460dee7e914be9354fec6344e4b112.png"}})]),e._v(" "),n("p",[e._v("点击左侧“云开发”下面的“Database”可以看到改应用下的数据表，ApiCloud称之为Class，其中Class名称下划线开始的是它默认的表。我们可以自定义自己的数据表，并在此处增加、修改或者删除数据。")]),e._v(" "),n("figure",{staticClass:"common"},[n("img",{staticStyle:{"max-width":"1200px"},attrs:{src:"http://800cx2.com1.z0.glb.clouddn.com/apicloud/bd83b7c03dcf2507eed15b399b02de17.png"}})]),e._v(" "),n("h3",{staticClass:"title"},[e._v("使用API")]),e._v(" "),n("p",[e._v("目前使用的是vue-resource插件作Ajax请求。首先获取所建应用的AppId和AppKey，在控制台点击“概览”可以看到：")]),e._v(" "),n("figure",{staticClass:"common"},[n("img",{staticStyle:{"max-width":"600px"},attrs:{src:"http://800cx2.com1.z0.glb.clouddn.com/apicloud/45713a6792da60c6de4b69c8c3dbaad3.png"}})]),e._v(" "),n("p",[e._v("新建或者导入sha.js，"),n("a",{attrs:{href:"https://github.com/bravelin/bravelin.github.io/blob/master/admin/source/src/utils/sha.js"}},[e._v("https://github.com/bravelin/bravelin.github.io/blob/master/admin/source/src/utils/sha.js")])]),e._v(" "),n("p",[e._v("封装的ajax请求：")]),e._v(" "),n("pre",[n("code",[e._v("import Vue from 'vue'\nimport VueResource from 'vue-resource'\nimport sha from './sha'\nimport Config from './config' // appId和appKey在config里面\n\nVue.config.productionTip = false\nVue.use(VueResource)\nVue.http.options.emulateJSON = true\nVue.http.headers.common['X-APICloud-AppId'] = Config.appId\nconst AppKey = Config.appId + 'UZ' + Config.appKey + 'UZ'\n\nVue.http.interceptors.push((request, next) => { // 设置全局的请求参数\n    let requestParam\n    if (request.method.toLowerCase() === 'get') {\n        request.params = request.params || {}\n        requestParam = request.params\n        requestParam['_'] = (+new Date()) // 时间戳\n    }\n    let now = (+new Date())\n    let appKey = sha(AppKey + now) + '.' + now // appKey的生成\n    request.headers.set('X-APICloud-AppKey', appKey)\n})\n\nexport default function fetch (options) {\n    options.method = options.method || 'GET'\n    if (options.data) {\n        options.body = options.data\n    }\n    return new Promise((resolve, reject) => {\n        Vue.http(options).then((res) => {\n            res = res.body\n            resolve(res)\n        }, (error) => {\n            reject(error)\n        })\n    })\n}")])]),e._v(" "),n("h3",{staticClass:"title"},[e._v("请求数据")]),e._v(" "),n("p",[e._v("例如，查询用户表里面的所有数据：")]),e._v(" "),n("pre",[n("code",[e._v("const that = this\nfetch({\n    url: 'https://d.apicloud.com/mcm/api/user'\n}).then(res => {\n    that.dataList = res || []\n    loading(false)\n})")])]),e._v(" "),n("p",[e._v("在记录数比较多的情况下分页查询，总页数需要额外请求，以下是查询file表的page页数据，每页记录数pageSize：")]),e._v(" "),n("pre",[n("code",[e._v("const that = this\npage = page || that.page\nlet searchKey = that.searchKey.trim()\nlet filter = {\n    limit: that.pageSize,\n    where: {},\n    skip: (page - 1) * that.pageSize,\n    order: 'createdAt DESC' // 按创建的时间倒序\n}\n// 求总的页数的请求filter\nlet totalPageFilter = {\n    fields: {\n        id: true\n    },\n    limit: 10000,\n    where: {}\n}\nif (searchKey) {\n    filter.where.name = { 'like': searchKey }\n    totalPageFilter.where.name = { 'like': searchKey }\n}\n\n// 查询总页数\nfetch({\n    url: 'https://d.apicloud.com/mcm/api/file',\n    params: { filter: JSON.stringify(totalPageFilter) }\n}).then(data => {\n    that.totalPage = Math.ceil(data.length / that.pageSize) // 获得总页数\n})\n// 查询当页数据\nfetch({\n    url: 'https://d.apicloud.com/mcm/api/file',\n    params: { filter: JSON.stringify(filter) }\n}).then(res => {\n    res = res || []\n    that.dataList = res\n    that.page = page\n    loading(false)\n})")])]),e._v(" "),n("h3",{staticClass:"title"},[e._v("删除数据")]),e._v(" "),n("p",[e._v("请求中method置为DELETE，并传入Class的ID，比如删除文件：")]),e._v(" "),n("pre",[n("code",[e._v("fetch({\n    url: 'https://d.apicloud.com/mcm/api/file/{fileId}',\n    method: 'DELETE',\n    params: {\n        fileId: that.delId\n    }\n}).then(() => {\n    tipShow('删除成功！')\n    loading(false)\n    that.queryDataList()\n})")])]),e._v(" "),n("h3",{staticClass:"title"},[e._v("修改数据")]),e._v(" "),n("p",[e._v("修改数据使用PUT，data里面放置需要修改的字段，如修改sentences表的某条记录的status字段：")]),e._v(" "),n("pre",[n("code",[e._v("const that = this\nloading(true)\nfetch({\n    url: 'https://d.apicloud.com/mcm/api/sentences/{id}',\n    method: 'put',\n    params: {\n        id: item.id\n    },\n    data: {\n        '$set': {\n            status: ope\n        }\n    }\n}).then(() => {\n    loading(false)\n    that.queryDataList()\n})")])]),e._v(" "),n("h3",{staticClass:"title"},[e._v("文件上传")]),e._v(" "),n("p",[e._v("需要引入"),n("a",{attrs:{href:"http://fex.baidu.com/webuploader/"}},[e._v("webuploader")]),e._v("，将以下几个文件放到static/webuploader下面：")]),e._v(" "),n("figure",{staticClass:"common"},[n("img",{staticStyle:{"max-width":"600px"},attrs:{src:"http://800cx2.com1.z0.glb.clouddn.com/apicloud/4f6458ca30b96f7bccc6e01c9af06c8c.png",alt:""}})]),e._v(" "),n("p",[e._v("在index.html里面引入：")]),e._v(" "),n("pre",[n("code",[e._v('<body>\n    <div id="app"></div>\n    <script type="text/javascript" src="./static/webuploader/jquery.min.js"><\/script>\n    <script type="text/javascript" src="./static/webuploader/webuploader.html5only.js"><\/script>\n</body>')])]),e._v(" "),n("p",[e._v("页面定义一个选择文件的按钮，如下是一个ID为file-picker的div：")]),e._v(" "),n("pre",[n("code",[e._v('<div v-show="fileList.length == 0"><div id="file-picker">选择文件</div></div>')])]),e._v(" "),n("p",[e._v("mounted生命周期中使用WebUploader.create初始化文件上传按钮：")]),e._v(" "),n("pre",[n("code",[e._v("mounted () {\n    const that = this\n    const AppKey = Config.appId + 'UZ' + Config.appKey + 'UZ'\n    that.$nextTick(() => {\n        that.wp = WebUploader.create({\n            server: 'https://d.apicloud.com/mcm/api/file',\n            auto: false,\n            pick: '#file-picker',\n            resize: false,\n            fileSingleSizeLimit: 20 * 1024 * 1024, // 单文件大小限制20M\n            fileSizeLimit: 50 * 1024 * 1024, // 总大小限制\n            fileNumLimit: 50 // 文件总数限制\n        })\n        that.wp.on('fileQueued', function (file) {\n            that.fileList.push({\n                id: file.id,\n                filename: file.name,\n                size: file.size,\n                progress: 0\n            })\n            that.wp.option('formData', {\n                filename: file.name,\n                type: file.type\n            })\n        })\n\n        // 文件上传成功\n        that.wp.on('uploadSuccess', function (file, res) {\n            if (res && res.id) {\n                that.uploadTip = file.name + '上传成功！'\n            } else if (res && res.status == 0) {\n                that.uploadTip = file.name + '上传失败！'\n            } else {\n                that.uploadTip = file.name + '上传失败'\n            }\n        })\n\n        // 文件上传失败\n        that.wp.on('uploadError', function (file, reason) {\n            that.uploadTip = file.name + '上传失败'\n        })\n\n        // 上传完成，不管成功失败\n        that.wp.on('uploadComplete', function (file) {\n            that.wp.removeFile(file)\n            that.uploadCount ++\n            if (that.fileList.length == that.uploadCount) {\n                setTimeout(() => {\n                    that.isShowUploaderModal = false\n                }, 1500)\n                that.queryDataList(1)\n            }\n        })\n\n        that.wp.on('uploadBeforeSend', function (block, data, headers) {\n            let now = (+new Date())\n            let appKey = sha(AppKey + now) + '.' + now\n            headers['X-APICloud-AppKey'] = appKey\n            headers['X-APICloud-AppId'] = Config.appId\n        })\n\n        // 上传中\n        that.wp.on('uploadProgress', function (file, percentage) {\n            let fileIndex = that.findFile(file.id)\n            if (fileIndex >= 0) {\n                let fileObj = that.fileList[fileIndex]\n                fileObj.progress = (percentage * 100).toFixed(0)\n                that.fileList.splice(fileIndex, 1, fileObj)\n            }\n        })\n    })\n}")])])])}]},s=n("Z0/y")(a,i,!1,null,null,null);t.default=s.exports}});